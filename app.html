<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Manager</title>
    <link rel="stylesheet" href="styles.css">


    
  </head>
  <body>
    <div class="app-container">
      <div class="form-container">
        <div class="control-section">
          <h3>Input</h3>
          <form id="eventForm">
            <input type="hidden" id="editIndex" />
            <input
              type="text"
              id="eventName"
              required
              placeholder="Enter event name"
              aria-label="Event name"
            />
            <input type="date" id="eventDate" required />
            <input type="time" id="eventTime" required />
            <div class="button-group">
              <button type="submit" id="submit">Add / Update</button>
              <button type="button" id="deleteSelected" disabled>Delete</button>
            </div>
          </form>
        </div>

        <div class="control-section">
          <h3>Read</h3>
          <div>
            <input
              type="text"
              id="searchInput"
              placeholder="Search events..."
            />
            <input type="date" id="startDate" placeholder="Start Date" />
            <input type="date" id="endDate" placeholder="End Date" />
            <select
              id="searchField"
              aria-label="Search field"
              style="display: none"
            >
              <option value="all" selected>All</option>
            </select>
            <div class="button-group">
              <button type="button" id="searchButton">Search</button>
              <button type="button" id="resetButton">Reset</button>
            </div>
          </div>

          <div class="filter-options">
            <select id="filterSelect">
              <option value="all">All Events - Deprecated</option>
              <option value="week">Events This Week - Deprecated</option>
            </select>
          </div>
        </div>

        <div class="control-section">          
          <div>
            <label for="toggleFreeDays">
              <input type="checkbox" id="toggleFreeDays" />
              Show Free Days
            </label>
          </div>
        </div>

        <!-- Dynamic Select TO replace -->
          <div class="button-group">
            <button id="selectAll" type="button" class="tooltip" style="display: none">
              Select All
              <span class="tooltiptext">Select all visible events</span>
            </button>
            <button id="selectBetween" type="button" class="tooltip" style="display: none">
              Select Between
              <span class="tooltiptext"
                >Select events between two selected events</span
              >
            </button>
          </div>
        
      </div>

      <div class="content-container">
        <div class="table-container">
          <h5 style="text-align: right; font-family: 'Arial', sans-serif"></h5>
          <div id="range-controls" style="display: none">
            <button id="prevRange" class="tooltip">
              &lt;
              <span class="tooltiptext">View previous week</span>
            </button>
            <span id="currentRange"></span>
            <button id="nextRange" class="tooltip">
              &gt;
              <span class="tooltiptext">View next week</span>
            </button>
          </div>
          <table id="eventTable">
            <thead>
              <tr>
                <th style="max-width: 15px; white-space: nowrap">
                  <div style="overflow: hidden; text-overflow: ellipsis">
                    <input
                      type="checkbox"
                      id="selectAllCheckbox"
                      class="tooltip"
                    />
                    <!-- <span class="tooltiptext"
                      >Select all displayed events or range of selected
                      events</span
                    > -->
                  </div>
                </th>
                <th>Date</th>
                <th>Time</th>
                <th>Event Name</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="pagination-controls" style="margin: 0px; padding: 0px">
            <button id="prevPage" class="tooltip">
              &lt;
              <span class="tooltiptext">View previous page</span>
            </button>
            <span id="pageInfo"></span>
            <button id="nextPage" class="tooltip">
              &gt;
              <span class="tooltiptext">View next page</span>
            </button>
          </div>
          <div id="noEventsFound">
            No events found matching your search criteria.
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", (event) => {
        //Variables
        const form = document.getElementById("eventForm");
        const table = document.getElementById("eventTable");
        const tbody = table.getElementsByTagName("tbody")[0];
        const eventNameField = document.getElementById("eventName");
        const eventDateField = document.getElementById("eventDate");
        const eventTimeField = document.getElementById("eventTime");
        const editIndexField = document.getElementById("editIndex");
        const filterSelect = document.getElementById("filterSelect");
        const viewSelect = document.getElementById("viewSelect");
        const selectAllButton = document.getElementById("selectAll");
        const selectBetweenButton = document.getElementById("selectBetween");
        const searchInput = document.getElementById("searchInput");
        const startDate = document.getElementById("startDate");
        const endDate = document.getElementById("endDate");
        const searchField = document.getElementById("searchField");
        const searchButton = document.getElementById("searchButton");
        const resetButton = document.getElementById("resetButton");
        const noEventsFoundMessage = document.getElementById("noEventsFound");
        const prevPageButton = document.getElementById("prevPage");
        const nextPageButton = document.getElementById("nextPage");
        const pageInfoSpan = document.getElementById("pageInfo");
        const rangeControls = document.getElementById("range-controls");
        const prevRangeButton = document.getElementById("prevRange");
        const nextRangeButton = document.getElementById("nextRange");
        const currentRangeSpan = document.getElementById("currentRange");
        const toggleFreeDaysCheckbox =
          document.getElementById("toggleFreeDays");
        const calendarContainer = document.querySelector(".calendar-container");
        const tableContainer = document.querySelector(".table-container");

        const currentWeekRangeSpan =
          document.getElementById("currentWeekRange");
        const calendarGrid = document.getElementById("calendarGrid");
        const selectAllCheckbox = document.getElementById("selectAllCheckbox");

        //FOR LOADING FREE WEEKS
        const WEEKS_BEFORE = 1;
        const WEEKS_AFTER = 1;
        const DAYS_IN_WEEK = 7;

        let selectedEvents = new Set();
        let lastSelectedIndex = null;
        let currentSortColumn = 1;
        let currentSortDirection = "asc";
        let currentPage = 1;
        let eventsPerPage = 8;
        let currentRangeStart = null;
        let currentRangeEnd = null;
        let showFreeDays = false;
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let currentWeekStart = new Date();
        currentWeekStart.setDate(
          currentWeekStart.getDate() - currentWeekStart.getDay()
        );
        let allEventsWithFreeDays = [];
        let allEvents = JSON.parse(localStorage.getItem("events")) || [];

        function formatDate(date, includeYear = true) {
          const options = {
            weekday: "long",
            day: "numeric",
            month: "long",
            year: includeYear ? "numeric" : undefined,
          };
          const formattedDate = new Date(date).toLocaleDateString(
            "en-US",
            options
          );
          const day = new Date(date).getDate();
          const suffix = getDaySuffix(day);
          return formattedDate.replace(/(\d+)/, `$1${suffix}`);
        }

        function getDaySuffix(day) {
          if (day > 3 && day < 21) return "th";
          switch (day % 10) {
            case 1:
              return "st";
            case 2:
              return "nd";
            case 3:
              return "rd";
            default:
              return "th";
          }
        }

        function loadEvents(filter = "all", searchParams = null, page = 1) {
          console.log(
            "Loading events. Filter:",
            filter,
            "Show free days:",
            showFreeDays,
            "Page:",
            page
          );

          // const events = allEvents;
          let filteredEvents = [];

          const today = new Date();
          const startOfWeek = new Date(today);
          startOfWeek.setDate(today.getDate() - today.getDay());
          const endOfWeek = new Date(startOfWeek);
          endOfWeek.setDate(startOfWeek.getDate() + 6);

          console.log(
            "Week range:",
            startOfWeek.toDateString(),
            "to",
            endOfWeek.toDateString()
          );

          if (filter === "week") {
            for (
              let d = new Date(startOfWeek);
              d <= endOfWeek;
              d.setDate(d.getDate() + 1)
            ) {
              const currentDate = new Date(d);
              const existingEvent = events.find(
                (event) =>
                  new Date(event.date).toDateString() ===
                  currentDate.toDateString()
              );

              if (existingEvent) {
                filteredEvents.push(existingEvent);
              } else if (showFreeDays) {
                filteredEvents.push({
                  name: "Free",
                  date: currentDate.toISOString().split("T")[0],
                  time: "--:--",
                });
              }
            }
          } else {
            filteredEvents = allEvents;
          }

          if (searchParams) {
            const { searchTerm, start, end } = searchParams;
            filteredEvents = filteredEvents.filter((event) => {
              const eventDate = new Date(event.date);
              const matchesTerm = searchTerm
                ? event.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                  event.date.includes(searchTerm) ||
                  event.time.includes(searchTerm) ||
                  eventDate
                    .toLocaleString("default", { month: "long" })
                    .toLowerCase()
                    .includes(searchTerm.toLowerCase())
                : true;
              const matchesDateRange =
                (!start || event.date >= start) && (!end || event.date <= end);
              return matchesTerm && matchesDateRange;
            });
          }

          console.log("Filtered events:", filteredEvents);

          const startIndex = (page - 1) * eventsPerPage;
          const endIndex = startIndex + eventsPerPage;
          const paginatedEvents = filteredEvents.slice(startIndex, endIndex);

          console.log("Paginated events:", paginatedEvents);

          tbody.innerHTML = "";
          paginatedEvents.forEach((event, index) => {
            const row = tbody.insertRow();
            const globalIndex = startIndex + index;
            const isFreeDay = event.name === "Free";

            row.innerHTML = `
              <td><input type="checkbox" ${
                selectedEvents.has(globalIndex) ? "checked" : ""
              } ${isFreeDay ? "disabled" : ""} /></td>
              <td>${formatDate(event.date)}</td>
              <td>${event.time}</td>
              <td>${event.name}</td>
            `;

            if (selectedEvents.has(globalIndex)) row.classList.add("selected");
            if (globalIndex === lastSelectedIndex)
              row.classList.add("last-selected");
            if (isFreeDay) row.classList.add("free-day");

            if (!isFreeDay) {
              row
                .querySelector('input[type="checkbox"]')
                .addEventListener("change", function () {
                  toggleEventSelection(this, globalIndex);
                });
            }
          });

          console.log("Table rows:", tbody.innerHTML);

          updatePagination(filteredEvents.length, page);
          sortTable(currentSortColumn, currentSortDirection);
          updateDeleteButtonState();

          noEventsFoundMessage.style.display =
            filteredEvents.length === 0 ? "block" : "none";
        }

        function loadWeeksWithFreeDays(page = 1) {
          const events = JSON.parse(localStorage.getItem("events")) || [];

          const earliestDate = new Date(
            Math.min(...events.map((e) => new Date(e.date)))
          );
          const startDate = new Date(earliestDate);
          startDate.setDate(startDate.getDate() - WEEKS_BEFORE * DAYS_IN_WEEK);
          const endDate = new Date();
          endDate.setDate(endDate.getDate() + WEEKS_AFTER * DAYS_IN_WEEK);

          let allDates = [];
          for (
            let d = new Date(startDate);
            d <= endDate;
            d.setDate(d.getDate() + 1)
          ) {
            allDates.push(new Date(d));
          }

          allEventsWithFreeDays = allDates.map((date) => {
            const existingEvent = events.find(
              (event) =>
                new Date(event.date).toDateString() === date.toDateString()
            );
            return (
              existingEvent || {
                name: "Free",
                date: date.toISOString().split("T")[0],
                time: "--:--",
              }
            );
          });

          const startIndex = (page - 1) * eventsPerPage;
          const endIndex = startIndex + eventsPerPage;
          const paginatedEvents = allEventsWithFreeDays.slice(
            startIndex,
            endIndex
          );

          renderEvents(paginatedEvents, startIndex);
          updatePagination(allEventsWithFreeDays.length, page);
          sortTable(currentSortColumn, currentSortDirection);
          updateDeleteButtonState();
        }

        function renderEvents(events, startIndex) {
          tbody.innerHTML = "";
          events.forEach((event, index) => {
            const row = tbody.insertRow();
            const globalIndex = startIndex + index;
            const isFreeDay = event.name === "Free";

            row.innerHTML = `
              <td><input type="checkbox" ${
                selectedEvents.has(globalIndex) ? "checked" : ""
              } ${isFreeDay ? "disabled" : ""} /></td>
              <td>${formatDate(event.date)}</td>
              <td>${event.time}</td>
              <td>${event.name}</td>
            `;

            if (selectedEvents.has(globalIndex)) row.classList.add("selected");
            if (globalIndex === lastSelectedIndex)
              row.classList.add("last-selected");
            if (isFreeDay) row.classList.add("free-day");

            if (!isFreeDay) {
              row
                .querySelector('input[type="checkbox"]')
                .addEventListener("change", function () {
                  toggleEventSelection(this, globalIndex);
                });
            }
          });
        }

        function updatePagination(totalEvents, currentPage) {
          const totalPages = Math.ceil(totalEvents / eventsPerPage);
          pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
          prevPageButton.disabled = currentPage === 1;
          nextPageButton.disabled = currentPage === totalPages;
        }

        function updateDeleteButtonState() {
          document.getElementById("deleteSelected").disabled =
            selectedEvents.size === 0;
        }

        function toggleEventSelection(checkbox, index) {
          const row = checkbox.closest("tr");
          if (checkbox.checked) {
            selectedEvents.add(index);
            row.classList.add("selected");
          } else {
            selectedEvents.delete(index);
            row.classList.remove("selected");
          }
          lastSelectedIndex = index;
          updateLastSelected();
          updateDeleteButtonState();

          const event = allEvents[index];
          if (event) {
            eventNameField.value = event.name;
            eventDateField.value = event.date;
            eventTimeField.value = event.time;
            editIndexField.value = index;
          }
        }

        function updateLastSelected() {
          const rows = Array.from(tbody.rows);
          rows.forEach((row) => row.classList.remove("last-selected"));
          if (lastSelectedIndex !== null) {
            const lastSelectedRow = rows.find((row) => {
              const checkbox = row.querySelector('input[type="checkbox"]');
              return (
                checkbox &&
                checkbox.checked &&
                Array.from(tbody.rows).indexOf(row) ===
                  lastSelectedIndex % eventsPerPage
              );
            });
            if (lastSelectedRow) {
              lastSelectedRow.classList.add("last-selected");
            }
          }
        }

        function editEvent(event) {
          const index = allEvents.findIndex(
            (e) =>
              e.date === event.date &&
              e.time === event.time &&
              e.name === event.name
          );
          if (index !== -1) {
            eventNameField.value = event.name;
            eventDateField.value = event.date;
            eventTimeField.value = event.time;
            editIndexField.value = index;
          }
        }

        function sortTable(column, direction = "asc") {
          const rows = Array.from(tbody.rows);
          const compare = (rowA, rowB) => {
            let cellA = rowA.cells[column].textContent.trim();
            let cellB = rowB.cells[column].textContent.trim();

            if (column === 1) {
              cellA = new Date(cellA).getTime();
              cellB = new Date(cellB).getTime();
            } else if (column === 2) {
              cellA = new Date(`1970-01-01T${cellA}`).getTime();
              cellB = new Date(`1970-01-01T${cellB}`).getTime();
            }

            if (cellA < cellB) return direction === "asc" ? -1 : 1;
            if (cellA > cellB) return direction === "asc" ? 1 : -1;
            return 0;
          };

          rows.sort(compare);

          tbody.append(...rows);

          Array.from(table.tHead.rows[0].cells).forEach((th, index) => {
            th.classList.remove("asc", "desc");
            if (index === column) {
              th.classList.add(direction);
            }
          });

          currentSortColumn = column;
          currentSortDirection = direction;
        }

        function dynamicSelectAll() {
          const checkboxes = tbody.querySelectorAll('input[type="checkbox"]');
          const allChecked = Array.from(checkboxes).every((cb) => cb.checked);

          checkboxes.forEach((checkbox, index) => {
            const globalIndex = (currentPage - 1) * eventsPerPage + index;
            checkbox.checked = !allChecked;
            const row = checkbox.closest("tr");
            if (!allChecked) {
              selectedEvents.add(globalIndex);
              row.classList.add("selected");
            } else {
              selectedEvents.delete(globalIndex);
              row.classList.remove("selected");
            }
          });

          updateLastSelected();
          updateDeleteButtonState();
        }

        // Event Listeners
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          const eventName = eventNameField.value;
          const eventDate = eventDateField.value;
          const eventTime = eventTimeField.value;
          const editIndex = editIndexField.value;

          if (editIndex === "") {
            allEvents.push({
              name: eventName,
              date: eventDate,
              time: eventTime,
            });
          } else {
            allEvents[editIndex] = {
              name: eventName,
              date: eventDate,
              time: eventTime,
            };
          }

          localStorage.setItem("events", JSON.stringify(allEvents)); //New Global allEvents variable
          console.log("Current Events:", JSON.stringify(allEvents));

          loadEvents(filterSelect.value, null, currentPage);

          form.reset();
          editIndexField.value = "";
          selectedEvents.clear();
          lastSelectedIndex = null;

          const now = new Date();
          eventDateField.value = now.toISOString().split("T")[0];
          eventTimeField.value = now.toTimeString().split(" ")[0].slice(0, 5);

          eventNameField.focus();
        });

        filterSelect.addEventListener("change", function () {
          loadEvents(this.value, null, 1);
        });

        searchButton.addEventListener("click", function () {
          const searchTerm = searchInput.value;
          const start = startDate.value;
          const end = endDate.value;
          const field = searchField.value;

          loadEvents(filterSelect.value, { searchTerm, start, end, field }, 1);
        });

        resetButton.addEventListener("click", function () {
          searchInput.value = "";
          startDate.value = "";
          endDate.value = "";
          searchField.value = "all";
          loadEvents(filterSelect.value, null, 1);
        });

        // Event listeners for pagination buttons
        prevPageButton.addEventListener("click", function () {
          if (currentPage > 1) {
            currentPage--;
            if (showFreeDays) {
              loadWeeksWithFreeDays(currentPage);
            } else {
              loadEvents(filterSelect.value, null, currentPage);
            }
          }
        });

        nextPageButton.addEventListener("click", function () {
          const events = showFreeDays
            ? allEventsWithFreeDays
            : JSON.parse(localStorage.getItem("events")) || [];
          const totalPages = Math.ceil(events.length / eventsPerPage);
          if (currentPage < totalPages) {
            currentPage++;
            if (showFreeDays) {
              loadWeeksWithFreeDays(currentPage);
            } else {
              loadEvents(filterSelect.value, null, currentPage);
            }
          }
        });

        selectAllButton.addEventListener("click", function () {
          const checkboxes = tbody.querySelectorAll('input[type="checkbox"]');
          const allChecked = Array.from(checkboxes).every((cb) => cb.checked);

          checkboxes.forEach((checkbox, index) => {
            const globalIndex = (currentPage - 1) * eventsPerPage + index;
            checkbox.checked = !allChecked;
            const row = checkbox.closest("tr");
            if (!allChecked) {
              selectedEvents.add(globalIndex);
              row.classList.add("selected");
            } else {
              selectedEvents.delete(globalIndex);
              row.classList.remove("selected");
            }
          });

          if (selectedEvents.size > 0) {
            lastSelectedIndex = Math.max(...selectedEvents);
            const lastSelectedRow =
              tbody.rows[lastSelectedIndex % eventsPerPage];
            if (lastSelectedRow) {
              lastSelectedRow.classList.add("last-selected");
            }
            const events = JSON.parse(localStorage.getItem("events")) || [];
            const event = events[lastSelectedIndex];
            if (event) {
              eventNameField.value = event.name;
              eventDateField.value = event.date;
              eventTimeField.value = event.time;
              editIndexField.value = lastSelectedIndex;
            }
          } else {
            lastSelectedIndex = null;
            form.reset();
            editIndexField.value = "";
            const now = new Date();
            eventDateField.value = now.toISOString().split("T")[0];
            eventTimeField.value = now.toTimeString().split(" ")[0].slice(0, 5);
          }
          updateDeleteButtonState();
        });

        selectBetweenButton.addEventListener("click", function () {
          const checkboxes = Array.from(
            tbody.querySelectorAll('input[type="checkbox"]')
          );
          const selectedIndices = checkboxes.reduce((acc, checkbox, index) => {
            if (checkbox.checked)
              acc.push((currentPage - 1) * eventsPerPage + index);
            return acc;
          }, []);

          if (selectedIndices.length !== 2) {
            alert("Please select exactly two events to select between.");
            return;
          }

          const [start, end] = selectedIndices.sort((a, b) => a - b);

          for (let i = start; i <= end; i++) {
            selectedEvents.add(i);
            const rowIndex = i % eventsPerPage;
            if (rowIndex < checkboxes.length) {
              checkboxes[rowIndex].checked = true;
              checkboxes[rowIndex].closest("tr").classList.add("selected");
            }
          }

          lastSelectedIndex = end;
          const lastSelectedRow = tbody.rows[lastSelectedIndex % eventsPerPage];
          if (lastSelectedRow) {
            lastSelectedRow.classList.add("last-selected");
          }

          const events = JSON.parse(localStorage.getItem("events")) || [];
          const event = events[lastSelectedIndex];
          if (event) {
            eventNameField.value = event.name;
            eventDateField.value = event.date;
            eventTimeField.value = event.time;
            editIndexField.value = lastSelectedIndex;
          }
          updateDeleteButtonState();
        });

        document
          .getElementById("deleteSelected")
          .addEventListener("click", function () {
            if (selectedEvents.size > 0) {
              allEvents = allEvents.filter(
                (_, index) => !selectedEvents.has(index)
              );
              localStorage.setItem("events", JSON.stringify(allEvents));
              loadEvents(filterSelect.value, null, 1);

              selectedEvents.clear();
              lastSelectedIndex = null;
              form.reset();
              editIndexField.value = "";
              const now = new Date();
              eventDateField.value = now.toISOString().split("T")[0];
              eventTimeField.value = now
                .toTimeString()
                .split(" ")[0]
                .slice(0, 5);
              eventNameField.focus();
              updateDeleteButtonState();
            } else {
              alert("Please select at least one event to delete.");
            }
          });

        toggleFreeDaysCheckbox.addEventListener("change", function () {
          showFreeDays = this.checked;
          currentPage = 1; // Reset to first page when toggling
          if (showFreeDays) {
            loadWeeksWithFreeDays(currentPage);
          } else {
            loadEvents(filterSelect.value, null, currentPage);
          }
        });

        Array.from(table.tHead.rows[0].cells).forEach((th, index) => {
          if (index > 0) {
            th.addEventListener("click", () => {
              const newDirection = th.classList.contains("asc")
                ? "desc"
                : "asc";
              sortTable(index, newDirection);
            });
          }
        });

        selectAllCheckbox.addEventListener("change", dynamicSelectAll);

        // Initialize views
        const now = new Date();
        eventDateField.value = now.toISOString().split("T")[0];
        eventTimeField.value = now.toTimeString().split(" ")[0].slice(0, 5);
        loadEvents();
        tableContainer.style.display = "block";
        document.getElementById("eventName").focus();
      });
    </script>
  </body>
</html>
