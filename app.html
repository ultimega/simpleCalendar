<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Calendar App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #082d71, #d1e7ff);
        overflow: hidden;
      }

      .form-container {
        width: 100%;
        max-width: 320px;
        background-color: #cb9647;
        padding: 5px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        border-radius: 10px;
        transform: translateZ(0);
      }

      .form-container h2 {
        margin-bottom: 20px;
        font-size: 24px;
        text-transform: uppercase;
        color: #343a40;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px;
        background-color: #f8f9fa;
        box-shadow: inset 1px 1px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      input:focus,
      select:focus {
        outline: none;
        transform: scale(1.02);
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
      }

      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 5px;
      }

      button,
      input[type="file"] {
        padding: 12px;
        background-color: #343a40;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1 0 calc(50% - 5px);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      button:hover,
      input[type="file"]:hover {
        background-color: #495057;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
      }

      button:active,
      input[type="file"]:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      #submit:hover {
        background-color: #236332;
      }

      #deleteSelected {
        background-color: #dc3545;
        color: white;
    }
    
    #deleteSelected:hover:not(:disabled) {
        background-color: #c82333;
    }
    
    #deleteSelected:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
        opacity: 0.65;
    }
    
      input[type="file"] {
        background-color: #6c757d;
      }

      .content-container {
        flex: 1;
        margin-left: 340px;
        margin-right: 10px;
        padding: 10px;
        overflow-y: auto;
        height: 100%;
        max-height: calc(100vh - 20px);
        background: #ffffff;
        border-radius: 15px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }

      @media (max-width: 768px) {
        .content-container {
          margin-left: 10px;
          margin-right: 10px;
        }
      }

      .table-container {
        display: none;
      }

      h2 {
        margin-bottom: 20px;
        font-size: 22px;
        text-transform: uppercase;
        color: #495057;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
      }

      th {
        background-color: #343a40;
        color: white;
        cursor: pointer;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        transition: background-color 0.2s ease;
      }

      th:hover {
        background-color: #495057;
      }

      th.asc::after {
        content: " ðŸ”¼";
      }

      th.desc::after {
        content: " ðŸ”½";
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      tbody tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      .highlighted {
        background-color: #e9ecef;
      }

      #calendar {
        max-width: 900px;
        margin: 0 auto;
      }

      .fc-event {
        cursor: pointer;
      }
      .fc-event.selected {
        background-color: #007bff;
        border-color: #0056b3;
      }
      th {
        cursor: pointer;
      }
      th:hover {
        background-color: #495057;
      }
      th::after {
        content: "\00a0\25B4\25BE";
        font-size: 0.8em;
        color: #adb5bd;
      }
      th.asc::after {
        content: "\00a0\25B4";
        color: white;
      }
      th.desc::after {
        content: "\00a0\25BE";
        color: white;
      }
      .selected {
        background-color: #e6f3ff;
      }
      .last-selected {
        background-color: #c8e6c9;
      }
      .search-filter-container {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .search-filter-container input,
      .search-filter-container select {
        margin-bottom: 10px;
      }
      .search-filter-container .button-group {
        justify-content: flex-start;
      }
      input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }
      #noEventsFound {
        display: none;
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
      }

      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltiptext {
        visibility: hidden;
        width: 120px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -60px;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      .free-day {
        background-color: #e6ffe6;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #e8f0ff, #d1e7ff);
        overflow: hidden;
      }

      .form-container {
        width: 340px;
        background-color: #fff;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        border-radius: 10px;
        transform: translateZ(0);
      }

      .control-section {
        border: 1px solid #510707f8;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .control-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 18px;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 5px;
      }

      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 0px;
      }

      .button-group button,
      .button-group input[type="file"] {
        flex: 1 0 calc(50% - 5px);
      }

      #deleteSelected {
        background-color: #dc3545;
      }

      #deleteSelected:hover {
        background-color: #c82333;
      }

      .search-filter-container {
        margin-top: 15px;
      }

      .search-filter-container input,
      .search-filter-container select {
        margin-bottom: 10px;
      }
      .search-filter-container .button-group {
        justify-content: flex-start;
      }
      input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }
      #noEventsFound {
        display: none;
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
      }

      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltiptext {
        visibility: hidden;
        width: 120px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -60px;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      .free-day {
        background-color: #e6ffe6;
      }

      .view-options {
        margin-top: 20px;
      }
      .view-options,
      .filter-options {
        display: flex;
        justify-content: space-between;
      }
      .view-options button,
      .filter-options button {
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        background-color: #007bff;
        color: #fff;
        transition: background-color 0.3s;
      }
      .view-options button:hover,
      .filter-options button:hover {
        background-color: #0056b3;
      }
      .view-options button:disabled,
      .filter-options button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .view-options button:disabled:hover,
      .filter-options button:disabled:hover {
        background-color: #ccc;
      }

      @media screen and (max-width: 768px) {
        #nextPage,
        #prevPage {
          margin: 1vw;
          font-size: 0.9rem;
        }
      }

      @media screen and (max-width: 480px) {
        #nextPage,
        #prevPage {
          margin: 0.5vw;
          font-size: 0.8rem;
        }
      }

      #nextPage,
      #prevPage,
      #prevRange,
      #nextRange {
        margin: 2vw;
        font-size: 1rem;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <div class="control-section">
        <h3>Input</h3>
        <form id="eventForm">
          <input type="hidden" id="editIndex" />
          <input
            type="text"
            id="eventName"
            required
            placeholder="Enter event name"
            aria-label="Event name"
          />
          <input type="date" id="eventDate" required />
          <input type="time" id="eventTime" required />
          <div class="button-group">
            <button type="submit" id="submit">Add / Update</button>
            <button type="button" id="deleteSelected" disabled>Delete</button>
          </div>
        </form>
      </div>

      <div class="control-section">
        <h3>Read</h3>
        <div class="search-filter-container">
          <input type="text" id="searchInput" placeholder="Search events..." />
          <input type="date" id="startDate" placeholder="Start Date" />
          <input type="date" id="endDate" placeholder="End Date" />
          <select id="searchField">
            <option value="all">All</option>
            <option value="name">Name</option>
            <option value="date">Date</option>
            <option value="time">Time</option>
          </select>
          <div class="button-group">
            <button type="button" id="searchButton">Search</button>
            <button type="button" id="resetButton">Reset</button>
          </div>
        </div>
        <div class="view-options">
          <!-- <label for="viewSelect">View:</label> -->
          <select id="viewSelect">
            <option value="list">List View</option>
            <option value="range">Calendar View</option>
          </select>
        </div>
        <div class="filter-options">
          <!-- <label for="filterSelect">Show:</label> -->
          <select id="filterSelect">
            <option value="all">All Events</option>
            <option value="week">Events This Week</option>
          </select>
        </div>
      </div>

      <div class="control-section">
        <h3>Batch</h3>
        <div class="button-group">
          <button id="selectAll" type="button" class="tooltip">
            Select All
            <span class="tooltiptext">Select all visible events</span>
          </button>
          <button id="selectBetween" type="button" class="tooltip">
            Select Between
            <span class="tooltiptext"
              >Select events between two selected events</span
            >
          </button>
          <button id="toggleFreeDays" type="button" class="tooltip">
            Toggle FreeDays
            <span class="tooltiptext">Show/Hide days without events</span>
          </button>
          <button type="button" id="exportCSV">Export as CSV</button>
          <div>
            <label for="loadCSV">Load CSV:</label>
            <input type="file" id="loadCSV" accept=".csv" />
          </div>
        </div>
      </div>
    </div>

    <div class="content-container">
      <div class="table-container">
        <h5 style="text-align: right; font-family: 'Arial', sans-serif"></h5>
        <div id="range-controls" style="display: none">
          <button id="prevRange" class="tooltip">
            &lt;
            <span class="tooltiptext">View previous week</span>
          </button>
          <span id="currentRange"></span>
          <button id="nextRange" class="tooltip">
            &gt;
            <span class="tooltiptext">View next week</span>
          </button>
        </div>
        <table id="eventTable">
          <thead>
            <tr>
              <th
                onclick="selectDynamic(_)"
                style="max-width: 15px; white-space: nowrap"
              >
                <div style="overflow: hidden; text-overflow: ellipsis">
                  <span title="`selectDynamic-yet to be implemented`">
                    `selectDynamic-yet to be implemented`</span
                  >
                </div>
              </th>
              <th onclick="sortTable(1)">Date</th>
              <th onclick="sortTable(2)">Time</th>
              <th onclick="sortTable(3)">Event Name</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="pagination-controls">
          <button id="prevPage" class="tooltip">
            &lt;
            <span class="tooltiptext">View previous page</span>
          </button>
          <span id="pageInfo"></span>
          <button id="nextPage" class="tooltip">
            &gt;
            <span class="tooltiptext">View next page</span>
          </button>
        </div>
        <div id="noEventsFound">
          No events found matching your search criteria.
        </div>
      </div>
    </div>


    <script>
      document.addEventListener("DOMContentLoaded", (event) => {
        const form = document.getElementById("eventForm");
        const table = document.getElementById("eventTable");
        const tbody = table.getElementsByTagName("tbody")[0];
        const eventNameField = document.getElementById("eventName");
        const eventDateField = document.getElementById("eventDate");
        const eventTimeField = document.getElementById("eventTime");
        const editIndexField = document.getElementById("editIndex");
        const filterSelect = document.getElementById("filterSelect");
        const viewSelect = document.getElementById("viewSelect");
        const selectAllButton = document.getElementById("selectAll");
        const selectBetweenButton = document.getElementById("selectBetween");
        const searchInput = document.getElementById("searchInput");
        const startDate = document.getElementById("startDate");
        const endDate = document.getElementById("endDate");
        const searchField = document.getElementById("searchField");
        const searchButton = document.getElementById("searchButton");
        const resetButton = document.getElementById("resetButton");
        const noEventsFoundMessage = document.getElementById("noEventsFound");
        const prevPageButton = document.getElementById("prevPage");
        const nextPageButton = document.getElementById("nextPage");
        const pageInfoSpan = document.getElementById("pageInfo");
        const rangeControls = document.getElementById("range-controls");
        const prevRangeButton = document.getElementById("prevRange");
        const nextRangeButton = document.getElementById("nextRange");
        const currentRangeSpan = document.getElementById("currentRange");
        let selectedEvents = new Set();
        let lastSelectedIndex = null;
        let currentSortColumn = 1; // Default sort by date
        let currentSortDirection = "asc";
        let currentPage = 1;
        let eventsPerPage = 10;
        let currentRangeStart = null;
        let currentRangeEnd = null;
      
        const toggleFreeDaysButton = document.getElementById("toggleFreeDays");
        let showFreeDays = false;
      
        // Prefill date and time with current info
        const now = new Date();
        eventDateField.value = now.toISOString().split("T")[0];
        eventTimeField.value = now.toTimeString().split(" ")[0].slice(0, 5);
      
        // Set focus on the event name field
        eventNameField.focus();
      
        function formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString("en-US", {
            weekday: "long",
            day: "numeric",
            month: "long",
            year: "numeric",
          });
        }
      
        function updateDeleteButtonState() {
          const deleteButton = document.getElementById("deleteSelected");
          deleteButton.disabled = selectedEvents.size === 0;
        }
      
        function loadEvents(filter = "all", searchParams = null, page = 1) {
          const events = JSON.parse(localStorage.getItem("events")) || [];
          tbody.innerHTML = "";
      
          const filteredEvents = events.filter((event) => {
            if (searchParams) {
              const { searchTerm, start, end, field } = searchParams;
              const eventDate = new Date(event.date);
      
              // Check date range
              if (start && end) {
                if (eventDate < new Date(start) || eventDate > new Date(end)) {
                  return false;
                }
              }
      
              // Check search term
              if (searchTerm) {
                if (field === "all") {
                  return Object.values(event).some((value) =>
                    value.toLowerCase().includes(searchTerm.toLowerCase())
                  );
                } else {
                  return event[field]
                    .toLowerCase()
                    .includes(searchTerm.toLowerCase());
                }
              }
            }
      
            // Apply existing filter
            if (filter === "week") {
              const today = new Date();
              const startOfWeek = new Date(
                today.setDate(today.getDate() - today.getDay())
              );
              const endOfWeek = new Date(
                today.setDate(today.getDate() - today.getDay() + 6)
              );
              const eventDate = new Date(event.date);
              return eventDate >= startOfWeek && eventDate <= endOfWeek;
            }
      
            return true;
          });
      
          if (filteredEvents.length === 0 && !showFreeDays) {
            noEventsFoundMessage.style.display = "block";
          } else {
            noEventsFoundMessage.style.display = "none";
          }
      
          // Sort events
          filteredEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
      
          // Generate all dates in the range
          let allDates = [];
          if (currentRangeStart && currentRangeEnd) {
            let currentDate = new Date(currentRangeStart);
            while (currentDate <= currentRangeEnd) {
              allDates.push(new Date(currentDate));
              currentDate.setDate(currentDate.getDate() + 1);
            }
          } else {
            // If no range is set, use the dates from filtered events
            allDates = filteredEvents.map((event) => new Date(event.date));
          }
      
          // Remove duplicates and sort
          allDates = [
            ...new Set(allDates.map((date) => date.toISOString().split("T")[0])),
          ].sort();
      
          // Pagination
          const startIndex = (page - 1) * eventsPerPage;
          const endIndex = startIndex + eventsPerPage;
          const paginatedDates = allDates.slice(startIndex, endIndex);
      
          paginatedDates.forEach((date) => {
            const eventsOnThisDay = filteredEvents.filter(
              (event) => event.date === date
            );
      
            if (eventsOnThisDay.length > 0) {
              eventsOnThisDay.forEach((event, index) => {
                const newRow = tbody.insertRow();
                const checkboxCell = newRow.insertCell(0);
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.onclick = () =>
                  toggleEventSelection(events.indexOf(event), newRow);
                checkboxCell.appendChild(checkbox);
      
                newRow.insertCell(1).textContent = formatDate(event.date);
                newRow.insertCell(2).textContent = event.time;
                newRow.insertCell(3).textContent = event.name;
      
                if (selectedEvents.has(events.indexOf(event))) {
                  checkbox.checked = true;
                  newRow.classList.add("selected");
                }
                if (events.indexOf(event) === lastSelectedIndex) {
                  newRow.classList.add("last-selected");
                }
              });
            } else if (showFreeDays) {
              const newRow = tbody.insertRow();
              newRow.classList.add("free-day");
              newRow.insertCell(0);
              newRow.insertCell(1).textContent = formatDate(date);
              newRow.insertCell(2).textContent = "Free Day";
              newRow.insertCell(3);
            }
          });
      
          updatePaginationControls(allDates.length, page);
          sortTable(currentSortColumn, currentSortDirection);
          updateDeleteButtonState();
        }
      
        function updatePaginationControls(totalEvents, currentPage) {
          const totalPages = Math.ceil(totalEvents / eventsPerPage);
          pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
          prevPageButton.disabled = currentPage === 1;
          nextPageButton.disabled = currentPage === totalPages;
        }
      
        function toggleEventSelection(index, element) {
          if (selectedEvents.has(index)) {
            selectedEvents.delete(index);
            element.classList.remove("selected");
          } else {
            selectedEvents.add(index);
            element.classList.add("selected");
          }
      
          // Update last selected
          if (lastSelectedIndex !== null) {
            const lastSelectedRow = Array.from(tbody.rows).find(
              (row) => row.classList.contains("last-selected")
            );
            if (lastSelectedRow) {
              lastSelectedRow.classList.remove("last-selected");
            }
          }
          lastSelectedIndex = index;
          element.classList.add("last-selected");
      
          // Prefill form with last selected item
          const events = JSON.parse(localStorage.getItem("events")) || [];
          const event = events[index];
          if (event) {
            eventNameField.value = event.name;
            eventDateField.value = event.date;
            eventTimeField.value = event.time;
            editIndexField.value = index;
          }
          updateDeleteButtonState();
        }
      
        toggleFreeDaysButton.addEventListener("click", function () {
          showFreeDays = !showFreeDays;
          loadEvents(filterSelect.value, null, currentPage);
        });
      
        form.addEventListener("submit", function (e) {
          e.preventDefault();
      
          const eventName = eventNameField.value;
          const eventDate = eventDateField.value;
          const eventTime = eventTimeField.value;
          const editIndex = editIndexField.value;
      
          const events = JSON.parse(localStorage.getItem("events")) || [];
      
          if (editIndex === "") {
            events.push({ name: eventName, date: eventDate, time: eventTime });
          } else {
            events[editIndex] = {
              name: eventName,
              date: eventDate,
              time: eventTime,
            };
          }
      
          localStorage.setItem("events", JSON.stringify(events));
          loadEvents(filterSelect.value, null, currentPage);
          form.reset();
          editIndexField.value = "";
          selectedEvents.clear();
          lastSelectedIndex = null;
      
          // Prefill date and time with current info
          const now = new Date();
          eventDateField.value = now.toISOString().split("T")[0];
          eventTimeField.value = now.toTimeString().split(" ")[0].slice(0, 5);
      
          // Set focus back to the event name field
          eventNameField.focus();
        });
      
        document.getElementById("exportCSV").addEventListener("click", function () {
          const events = JSON.parse(localStorage.getItem("events")) || [];
          let csvContent = "data:text/csv;charset=utf-8,Event Name,Date,Time\n";
      
          events.forEach((event) => {
            const row = `${event.name},${event.date},${event.time}`;
            csvContent += row + "\n";
          });
      
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "events.csv");
          document.body.appendChild(link);
      
          link.click();
          document.body.removeChild(link);
        });
      
        document.getElementById("loadCSV").addEventListener("change", function (event) {
          const file = event.target.files[0];
          const reader = new FileReader();
      
          reader.onload = function (e) {
            const content = e.target.result;
            const lines = content.split("\n");
      
            localStorage.removeItem("events");
      
            const events = [];
      
            for (let i = 1; i < lines.length; i++) {
              const line = lines[i].trim();
              if (line) {
                const [name, date, time] = line.split(",");
                events.push({
                  name: name.trim(),
                  date: date.trim(),
                  time: time.trim(),
                });
              }
            }
      
            localStorage.setItem("events", JSON.stringify(events));
      
            loadEvents(filterSelect.value, null, 1);
      
            event.target.value = "";
          };
      
          reader.readAsText(file);
        });
      
        selectAllButton.addEventListener("click", function () {
          const checkboxes = tbody.querySelectorAll('input[type="checkbox"]');
          const allChecked = Array.from(checkboxes).every((cb) => cb.checked);
      
          checkboxes.forEach((checkbox, index) => {
            const globalIndex = (currentPage - 1) * eventsPerPage + index;
            checkbox.checked = !allChecked;
            const row = checkbox.closest("tr");
            if (!allChecked) {
              selectedEvents.add(globalIndex);
              row.classList.add("selected");
            } else {
              selectedEvents.delete(globalIndex);
              row.classList.remove("selected");
            }
          });
      
          if (selectedEvents.size > 0) {
            lastSelectedIndex = Math.max(...selectedEvents);
            const lastSelectedRow = tbody.rows[lastSelectedIndex % eventsPerPage];
            if (lastSelectedRow) {
              lastSelectedRow.classList.add("last-selected");
            }
            const events = JSON.parse(localStorage.getItem("events")) || [];
            const event = events[lastSelectedIndex];
            if (event) {
              eventNameField.value = event.name;
              eventDateField.value = event.date;
              eventTimeField.value = event.time;
              editIndexField.value = lastSelectedIndex;
            }
          } else {
            lastSelectedIndex = null;
            form.reset();
            editIndexField.value = "";
            // Prefill date and time with current info
            const now = new Date();
            eventDateField.value = now.toISOString().split("T")[0];
            eventTimeField.value = now.toTimeString().split(" ")[0].slice(0, 5);
          }
          updateDeleteButtonState();
        });
      
        selectBetweenButton.addEventListener("click", function () {
          const checkboxes = Array.from(
            tbody.querySelectorAll('input[type="checkbox"]')
          );
          const selectedIndices = checkboxes.reduce((acc, checkbox, index) => {
            if (checkbox.checked)
              acc.push((currentPage - 1) * eventsPerPage + index);
            return acc;
          }, []);
      
          if (selectedIndices.length !== 2) {
            alert("Please select exactly two events to select between.");
            return;
          }
      
          const [start, end] = selectedIndices.sort((a, b) => a - b);
      
          for (let i = start; i <= end; i++) {
            selectedEvents.add(i);
            const rowIndex = i % eventsPerPage;
            if (rowIndex < checkboxes.length) {
              checkboxes[rowIndex].checked = true;
              checkboxes[rowIndex].closest("tr").classList.add("selected");
            }
          }
      
          lastSelectedIndex = end;
          const lastSelectedRow = tbody.rows[lastSelectedIndex % eventsPerPage];
          if (lastSelectedRow) {
            lastSelectedRow.classList.add("last-selected");
          }
      
          const events = JSON.parse(localStorage.getItem("events")) || [];
          const event = events[lastSelectedIndex];
          if (event) {
            eventNameField.value = event.name;
            eventDateField.value = event.date;
            eventTimeField.value = event.time;
            editIndexField.value = lastSelectedIndex;
          }
          updateDeleteButtonState();
        });
      
        document
          .getElementById("deleteSelected")
          .addEventListener("click", function () {
            if (selectedEvents.size > 0) {
              const events = JSON.parse(localStorage.getItem("events")) || [];
              const newEvents = events.filter(
                (_, index) => !selectedEvents.has(index)
              );
              localStorage.setItem("events", JSON.stringify(newEvents));
              loadEvents(filterSelect.value, null, 1);
              selectedEvents.clear();
              lastSelectedIndex = null;
              form.reset();
              editIndexField.value = "";
              // Prefill date and time with current info
              const now = new Date();
              eventDateField.value = now.toISOString().split("T")[0];
              eventTimeField.value = now
                .toTimeString()
                .split(" ")[0]
                .slice(0, 5);
              // Set focus back to the event name field
              eventNameField.focus();
              updateDeleteButtonState();
            } else {
              alert("Please select at least one event to delete.");
            }
          });

        // ... (keep other existing event listeners) ...

        function sortTable(column, direction = "asc") {
          const rows = Array.from(tbody.rows);
          const compare = (rowA, rowB) => {
            let cellA = rowA.cells[column].textContent.trim();
            let cellB = rowB.cells[column].textContent.trim();

            // For date column, convert to timestamp for proper sorting
            if (column === 1) {
              cellA = new Date(cellA).getTime();
              cellB = new Date(cellB).getTime();
            } else if (column === 2) {
              // Add time sorting logic if needed
              cellA = new Date(`1970-01-01T${cellA}`).getTime();
              cellB = new Date(`1970-01-01T${cellB}`).getTime();
            }

            if (cellA < cellB) return direction === "asc" ? -1 : 1;
            if (cellA > cellB) return direction === "asc" ? 1 : -1;
            return 0;
          };

          rows.sort(compare);

          tbody.append(...rows);

          // Update sort indicators
          Array.from(table.tHead.rows[0].cells).forEach((th, index) => {
            th.classList.remove("asc", "desc");
            if (index === column) {
              th.classList.add(direction);
            }
          });

          currentSortColumn = column;
          currentSortDirection = direction;
        }

        // Add click event listeners to table headers for sorting
        Array.from(table.tHead.rows[0].cells).forEach((th, index) => {
          if (index > 0) {
            // Skip the first column (checkbox column)
            th.addEventListener("click", () => {
              const newDirection = th.classList.contains("asc")
                ? "desc"
                : "asc";
              sortTable(index, newDirection);
            });
          }
        });

        viewSelect.addEventListener("change", function () {
          const listView = document.querySelector(".table-container");

          if (this.value === "list") {
            listView.style.display = "block";
            rangeControls.style.display = "none";
            loadEvents(filterSelect.value, null, 1);
          } else {
            listView.style.display = "block";
            rangeControls.style.display = "block";
            setCurrentWeekRange();
          }
        });

        searchButton.addEventListener("click", function () {
          const searchTerm = searchInput.value;
          const start = startDate.value;
          const end = endDate.value;
          const field = searchField.value;

          loadEvents(filterSelect.value, { searchTerm, start, end, field }, 1);
        });

        resetButton.addEventListener("click", function () {
          searchInput.value = "";
          startDate.value = "";
          endDate.value = "";
          searchField.value = "all";
          loadEvents(filterSelect.value, null, 1);
        });

        filterSelect.addEventListener("change", function () {
          loadEvents(this.value, null, 1);
        });

        prevPageButton.addEventListener("click", function () {
          if (currentPage > 1) {
            currentPage--;
            loadEvents(filterSelect.value, null, currentPage);
          }
        });

        nextPageButton.addEventListener("click", function () {
          const events = JSON.parse(localStorage.getItem("events")) || [];
          const totalPages = Math.ceil(events.length / eventsPerPage);
          if (currentPage < totalPages) {
            currentPage++;
            loadEvents(filterSelect.value, null, currentPage);
          }
        });

        function setCurrentWeekRange() {
          const today = new Date();
          currentRangeStart = new Date(
            today.setDate(today.getDate() - today.getDay())
          );
          currentRangeEnd = new Date(
            today.setDate(today.getDate() - today.getDay() + 6)
          );
          updateRangeView();
        }

        // Initialize the view and load events
        viewSelect.dispatchEvent(new Event("change"));
        loadEvents();
        sortTable(1, "asc"); // Sort by date initially
      });
    </script>
  </body>
</html>