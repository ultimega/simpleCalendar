<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Claude - Improved Event Manager</title>

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Arial, sans-serif;
        display: flex;
        min-height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #082d71, #d1e7ff);
        padding: 8px;
        overflow: hidden;
      }

      .app-container {
        display: flex;
        width: 100%;
        height: 100vh;
        margin: 0 auto;
        background-color: rgba(0, 0, 0, 0.684);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .form-container {
        width: 35%; /* Increased from 30% */
        max-width: 400px; /* Increased from 340px */
        background-color: #ffffff;
        padding: 15px; /* Reduced from 20px */
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1;
        transform: translateZ(20px);
        transition: transform 0.3s ease;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .form-container:hover {
        transform: translateZ(30px);
      }

      .content-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
        height: 100vh;
        background: #ffffff;
        border-radius: 15px;
      }

      h2,
      h3 {
        margin-bottom: 20px;
        font-size: 24px;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 10px;
        text-transform: uppercase;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
      }

      .control-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transform: translateZ(10px);
        transition: transform 0.3s ease;
        border: 1px solid #510707f8;
      }

      .control-section:hover {
        transform: translateZ(20px);
      }

      .control-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 18px;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 5px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px;
        background-color: #f8f9fa;
        box-shadow: inset 1px 1px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      input:focus,
      select:focus {
        outline: none;
        transform: scale(1.02);
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
      }

      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
      }

      button,
      input[type="file"] {
        padding: 12px;
        background-color: #343a40;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1 0 calc(50% - 5px);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      button:hover,
      input[type="file"]:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
      }

      #submit:hover {
        background-color: rgb(0, 120, 0);
      }

      button:active,
      input[type="file"]:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        opacity: 0.65;
      }

      #deleteSelected {
        background-color: #dc3545;
      }

      #deleteSelected:hover:not(:disabled) {
        background-color: #c82333;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #22922f78;
      }

      th {
        background-color: #343a40;
        color: white;
        cursor: pointer;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        transition: background-color 0.2s ease;
      }

      th:hover {
        background-color: #495057;
      }

      th::after {
        content: "\00a0\25B4\25BE";
        font-size: 1.2em;
        color: #adb5bd;
      }

      th.asc::after {
        content: "\00a0\25B4";
        color: white;
      }

      th.desc::after {
        content: "\00a0\25BE";
        color: white;
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      tbody tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      tbody tr:hover {
        background-color: #e9ecef;
      }

      .selected {
        background-color: #e7f5ff;
      }

      .last-selected {
        background-color: #cce5ff;
      }

      .calendar-container {
        display: flex;
        flex-direction: column;
      }

      .calendar-controls {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
      }

      #yearSelect,
      #monthSelect,
      #prevWeek,
      #nextWeek {
        padding: 8px;
        border-radius: 4px;
        font-size: 16px;
        flex: 1;
        min-width: 80px;
        max-width: 120px;
      }

      #prevWeek,
      #nextWeek {
        border: none;
        cursor: pointer;
      }

      .calendar-grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .calendar-column {
        display: flex;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
      }

      .calendar-date {
        flex: 0 0 100px;
        padding: 10px;
        background-color: #f8f9fa;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .calendar-events {
        flex: 1;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .calendar-event {
        background-color: #e7f5ff;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .calendar-event:hover {
        background-color: #cce5ff;
        transform: translateY(-2px);
      }

      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltiptext {
        visibility: hidden;
        width: 120px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -60px;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      .feedback {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
        display: none;
      }

      .feedback.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .feedback.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      .feedback.show {
        display: block;
        animation: fadeInOut 3s ease-in-out;
      }

      .search-filter-container {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .search-filter-container input,
      .search-filter-container select {
        margin-bottom: 10px;
      }

      .search-filter-container .button-group {
        justify-content: flex-start;
      }

      input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      #noEventsFound {
        display: none;
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
      }

      .free-day {
        background-color: #e6ffe6;
      }

      .view-options,
      .filter-options {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
      }

      .view-options button,
      .filter-options button {
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        background-color: #007bff;
        color: #fff;
        transition: background-color 0.3s;
      }

      .view-options button:hover,
      .filter-options button:hover {
        background-color: #0056b3;
      }

      .view-options button:disabled,
      .filter-options button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      #nextPage,
      #prevPage,
      #prevRange,
      #nextRange {
        margin: 2vw;
        font-size: 1rem;
        border-radius: 10px;
      }

      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
          height: auto;
        }

        .form-container {
          width: 100%;
          max-width: 100%; /* Changed from 00% to 100% */
          margin-bottom: 20px;
        }

        .content-container {
          height: auto;
          margin-left: 0;
          margin-right: 0;
        }

        .calendar-controls {
          flex-direction: column;
          align-items: stretch;
        }

        #yearSelect,
        #monthSelect,
        #prevWeek,
        #nextWeek {
          max-width: 100%;
        }

        #nextPage,
        #prevPage {
          margin: 1vw;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 480px) {
        #nextPage,
        #prevPage {
          margin: 0.5vw;
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="form-container">
        <div class="control-section">
          <h3>Input</h3>
          <form id="eventForm">
            <input type="hidden" id="editIndex" />
            <input
              type="text"
              id="eventName"
              required
              placeholder="Enter event name"
              aria-label="Event name"
            />
            <input type="date" id="eventDate" required />
            <input type="time" id="eventTime" required />
            <div class="button-group">
              <button type="submit" id="submit">Add / Update</button>
              <button type="button" id="deleteSelected" disabled>Delete</button>
            </div>
          </form>
        </div>

        <div class="control-section">
          <h3>Read</h3>
          <div class="search-filter-container">
            <input
              type="text"
              id="searchInput"
              placeholder="Search events..."
            />
            <input type="date" id="startDate" placeholder="Start Date" />
            <input type="date" id="endDate" placeholder="End Date" />
            <select id="searchField">
              <option value="all">All</option>
              <option value="name">Name</option>
              <option value="date">Date</option>
              <option value="time">Time</option>
            </select>
            <div class="button-group">
              <button type="button" id="searchButton">Search</button>
              <button type="button" id="resetButton">Reset</button>
            </div>
          </div>
          <div class="view-options">
            <select id="viewSelect">
              <option value="list">List View</option>
              <option value="calendar">Calendar View</option>
            </select>
          </div>
          <div class="filter-options">
            <select id="filterSelect">
              <option value="all">All Events</option>
              <option value="week">Events This Week</option>
            </select>
          </div>
        </div>

        <div class="control-section">
          <h3>Batch</h3>
          <div class="button-group">
            <button id="selectAll" type="button" class="tooltip">
              Select All
              <span class="tooltiptext">Select all visible events</span>
            </button>
            <button id="selectBetween" type="button" class="tooltip">
              Select Between
              <span class="tooltiptext"
                >Select events between two selected events</span
              >
            </button>
            <button id="toggleFreeDays" type="button" class="tooltip">
              Toggle FreeDays
              <span class="tooltiptext">Show/Hide days without events</span>
            </button>
            <button type="button" id="exportCSV">Export as CSV</button>
            <div>
              <label for="loadCSV">Load CSV:</label>
              <input type="file" id="loadCSV" accept=".csv" />
            </div>
          </div>
        </div>
      </div>

      <div class="content-container">
        <div class="table-container">
          <h5 style="text-align: right; font-family: 'Arial', sans-serif"></h5>
          <div id="range-controls" style="display: none">
            <button id="prevRange" class="tooltip">
              &lt;
              <span class="tooltiptext">View previous week</span>
            </button>
            <span id="currentRange"></span>
            <button id="nextRange" class="tooltip">
              &gt;
              <span class="tooltiptext">View next week</span>
            </button>
          </div>
          <table id="eventTable">
            <thead>
              <tr>
                <th style="max-width: 15px; white-space: nowrap">
                  <div style="overflow: hidden; text-overflow: ellipsis">
                    <span title="Select">Select</span>
                  </div>
                </th>
                <th>Date</th>
                <th>Time</th>
                <th>Event Name</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="pagination-controls">
            <button id="prevPage" class="tooltip">
              &lt;
              <span class="tooltiptext">View previous page</span>
            </button>
            <span id="pageInfo"></span>
            <button id="nextPage" class="tooltip">
              &gt;
              <span class="tooltiptext">View next page</span>
            </button>
          </div>
          <div id="noEventsFound">
            No events found matching your search criteria.
          </div>
        </div>

        <div class="calendar-container">
          <div class="calendar-controls">
            <select id="yearSelect"></select>
            <select id="monthSelect"></select>
            <div class="rangecal">
              <button id="prevWeek">&lt;</button>
              <span id="currentWeekRange"></span>
              <button id="nextWeek">&gt;</button>
            </div>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", (event) => {
        // Existing variables and functions
        const form = document.getElementById("eventForm");
        const table = document.getElementById("eventTable");
        const tbody = table.getElementsByTagName("tbody")[0];
        const eventNameField = document.getElementById("eventName");
        const eventDateField = document.getElementById("eventDate");
        const eventTimeField = document.getElementById("eventTime");
        const editIndexField = document.getElementById("editIndex");
        const filterSelect = document.getElementById("filterSelect");
        const viewSelect = document.getElementById("viewSelect");
        const selectAllButton = document.getElementById("selectAll");
        const selectBetweenButton = document.getElementById("selectBetween");
        const searchInput = document.getElementById("searchInput");
        const startDate = document.getElementById("startDate");
        const endDate = document.getElementById("endDate");
        const searchField = document.getElementById("searchField");
        const searchButton = document.getElementById("searchButton");
        const resetButton = document.getElementById("resetButton");
        const noEventsFoundMessage = document.getElementById("noEventsFound");
        const prevPageButton = document.getElementById("prevPage");
        const nextPageButton = document.getElementById("nextPage");
        const pageInfoSpan = document.getElementById("pageInfo");
        const rangeControls = document.getElementById("range-controls");
        const prevRangeButton = document.getElementById("prevRange");
        const nextRangeButton = document.getElementById("nextRange");
        const currentRangeSpan = document.getElementById("currentRange");
        let selectedEvents = new Set();
        let lastSelectedIndex = null;
        let currentSortColumn = 1;
        let currentSortDirection = "asc";
        let currentPage = 1;
        let eventsPerPage = 10;
        let currentRangeStart = null;
        let currentRangeEnd = null;
        const toggleFreeDaysButton = document.getElementById("toggleFreeDays");
        let showFreeDays = false;

        // New variables for calendar view
        const calendarContainer = document.querySelector(".calendar-container");
        const tableContainer = document.querySelector(".table-container");
        const yearSelect = document.getElementById("yearSelect");
        const monthSelect = document.getElementById("monthSelect");
        const prevWeekButton = document.getElementById("prevWeek");
        const nextWeekButton = document.getElementById("nextWeek");
        const currentWeekRangeSpan =
          document.getElementById("currentWeekRange");
        const calendarGrid = document.getElementById("calendarGrid");

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let currentWeekStart = new Date();
        currentWeekStart.setDate(
          currentWeekStart.getDate() - currentWeekStart.getDay()
        );

        function formatDate(date) {
          return date.toISOString().split("T")[0];
        }

        function loadEvents(filter = "all", searchParams = null, page = 1) {
          const events = JSON.parse(localStorage.getItem("events")) || [];
          let filteredEvents = events;

          if (filter === "week") {
            const today = new Date();
            const startOfWeek = new Date(
              today.setDate(today.getDate() - today.getDay())
            );
            const endOfWeek = new Date(
              today.setDate(today.getDate() - today.getDay() + 6)
            );
            filteredEvents = events.filter((event) => {
              const eventDate = new Date(event.date);
              return eventDate >= startOfWeek && eventDate <= endOfWeek;
            });
          }

          if (searchParams) {
            filteredEvents = filteredEvents.filter((event) => {
              const matchesTerm =
                event.name
                  .toLowerCase()
                  .includes(searchParams.searchTerm.toLowerCase()) ||
                event.date.includes(searchParams.searchTerm) ||
                event.time.includes(searchParams.searchTerm);
              const matchesDate =
                (!searchParams.start || event.date >= searchParams.start) &&
                (!searchParams.end || event.date <= searchParams.end);
              return matchesTerm && matchesDate;
            });
          }

          tbody.innerHTML = "";
          const startIndex = (page - 1) * eventsPerPage;
          const endIndex = startIndex + eventsPerPage;
          const paginatedEvents = filteredEvents.slice(startIndex, endIndex);

          paginatedEvents.forEach((event, index) => {
            const row = tbody.insertRow();
            const globalIndex = startIndex + index;
            row.innerHTML = `
              <td><input type="checkbox" ${
                selectedEvents.has(globalIndex) ? "checked" : ""
              } /></td>
              <td>${event.date}</td>
              <td>${event.time}</td>
              <td>${event.name}</td>
            `;
            if (selectedEvents.has(globalIndex)) {
              row.classList.add("selected");
            }
            if (globalIndex === lastSelectedIndex) {
              row.classList.add("last-selected");
            }
            row
              .querySelector('input[type="checkbox"]')
              .addEventListener("change", function () {
                toggleEventSelection(this, globalIndex);
              });
          });

          updatePagination(filteredEvents.length, page);
          sortTable(currentSortColumn, currentSortDirection);
          updateDeleteButtonState();

          if (filteredEvents.length === 0) {
            noEventsFoundMessage.style.display = "block";
          } else {
            noEventsFoundMessage.style.display = "none";
          }

          // Update calendar view
          updateCalendarView();
        }

        function updatePagination(totalEvents, currentPage) {
          const totalPages = Math.ceil(totalEvents / eventsPerPage);
          pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
          prevPageButton.disabled = currentPage === 1;
          nextPageButton.disabled = currentPage === totalPages;
        }

        function updateDeleteButtonState() {
          document.getElementById("deleteSelected").disabled =
            selectedEvents.size === 0;
        }

        function toggleEventSelection(checkbox, index) {
          const row = checkbox.closest("tr");
          if (checkbox.checked) {
            selectedEvents.add(index);
            row.classList.add("selected");
          } else {
            selectedEvents.delete(index);
            row.classList.remove("selected");
          }
          lastSelectedIndex = index;
          updateLastSelected();
          updateDeleteButtonState();

          const events = JSON.parse(localStorage.getItem("events")) || [];
          const event = events[index];
          if (event) {
            eventNameField.value = event.name;
            eventDateField.value = event.date;
            eventTimeField.value = event.time;
            editIndexField.value = index;
          }
        }

        function updateLastSelected() {
          const rows = Array.from(tbody.rows);
          rows.forEach((row) => row.classList.remove("last-selected"));
          if (lastSelectedIndex !== null) {
            const lastSelectedRow = rows.find((row) => {
              const checkbox = row.querySelector('input[type="checkbox"]');
              return (
                checkbox &&
                checkbox.checked &&
                Array.from(tbody.rows).indexOf(row) ===
                  lastSelectedIndex % eventsPerPage
              );
            });
            if (lastSelectedRow) {
              lastSelectedRow.classList.add("last-selected");
            }
          }
        }

        function initializeSelects() {
          const currentYear = new Date().getFullYear();
          yearSelect.innerHTML = "";
          for (let year = currentYear - 10; year <= currentYear + 10; year++) {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
          }
          yearSelect.value = currentYear;

          monthSelect.innerHTML = "";
          const months = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
          ];
          months.forEach((month, index) => {
            const option = document.createElement("option");
            option.value = index;
            option.textContent = month;
            monthSelect.appendChild(option);
          });
          monthSelect.value = currentMonth;
        }

        function updateCalendarView() {
          const weekStart = new Date(currentWeekStart);
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);

          currentWeekRangeSpan.textContent = `${formatDate(
            weekStart
          )} - ${formatDate(weekEnd)}`;

          calendarGrid.innerHTML = "";

          for (let i = 6; i >= 0; i--) {
            const day = new Date(weekEnd);
            day.setDate(day.getDate() - i);

            const column = document.createElement("div");
            column.classList.add("calendar-column");

            const dateDiv = document.createElement("div");
            dateDiv.classList.add("calendar-date");
            dateDiv.textContent = `${day.toLocaleDateString("en-US", {
              weekday: "short",
            })} ${formatDate(day)}`;
            column.appendChild(dateDiv);

            const eventsDiv = document.createElement("div");
            eventsDiv.classList.add("calendar-events");

            const events = getEventsForDate(day);
            events.forEach((event) => {
              const eventDiv = document.createElement("div");
              eventDiv.classList.add("calendar-event");
              eventDiv.textContent = `${event.time} - ${event.name}`;
              eventDiv.addEventListener("click", () => editEvent(event));
              eventsDiv.appendChild(eventDiv);
            });

            column.appendChild(eventsDiv);
            calendarGrid.appendChild(column);
          }
        }

        function getEventsForDate(date) {
          const events = JSON.parse(localStorage.getItem("events")) || [];
          return events.filter((event) => {
            const eventDate = new Date(event.date);
            return eventDate.toDateString() === date.toDateString();
          });
        }

        function editEvent(event) {
          const events = JSON.parse(localStorage.getItem("events")) || [];
          const index = events.findIndex(
            (e) =>
              e.date === event.date &&
              e.time === event.time &&
              e.name === event.name
          );
          if (index !== -1) {
            eventNameField.value = event.name;
            eventDateField.value = event.date;
            eventTimeField.value = event.time;
            editIndexField.value = index;
          }
        }

        function sortTable(column, direction = "asc") {
          const rows = Array.from(tbody.rows);
          const compare = (rowA, rowB) => {
            let cellA = rowA.cells[column].textContent.trim();
            let cellB = rowB.cells[column].textContent.trim();

            if (column === 1) {
              cellA = new Date(cellA).getTime();
              cellB = new Date(cellB).getTime();
            } else if (column === 2) {
              cellA = new Date(`1970-01-01T${cellA}`).getTime();
              cellB = new Date(`1970-01-01T${cellB}`).getTime();
            }

            if (cellA < cellB) return direction === "asc" ? -1 : 1;
            if (cellA > cellB) return direction === "asc" ? 1 : -1;
            return 0;
          };

          rows.sort(compare);

          tbody.append(...rows);

          Array.from(table.tHead.rows[0].cells).forEach((th, index) => {
            th.classList.remove("asc", "desc");
            if (index === column) {
              th.classList.add(direction);
            }
          });

          currentSortColumn = column;
          currentSortDirection = direction;
        }

        // Event Listeners
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          const eventName = eventNameField.value;
          const eventDate = eventDateField.value;
          const eventTime = eventTimeField.value;
          const editIndex = editIndexField.value;

          const events = JSON.parse(localStorage.getItem("events")) || [];

          if (editIndex === "") {
            events.push({ name: eventName, date: eventDate, time: eventTime });
          } else {
            events[editIndex] = {
              name: eventName,
              date: eventDate,
              time: eventTime,
            };
          }

          localStorage.setItem("events", JSON.stringify(events));
          loadEvents(filterSelect.value, null, currentPage);
          updateCalendarView();
          form.reset();
          editIndexField.value = "";
          selectedEvents.clear();
          lastSelectedIndex = null;

          const now = new Date();
          eventDateField.value = now.toISOString().split("T")[0];
          eventTimeField.value = now.toTimeString().split(" ")[0].slice(0, 5);

          eventNameField.focus();
        });

        viewSelect.addEventListener("change", function () {
          if (this.value === "list") {
            tableContainer.style.display = "block";
            calendarContainer.style.display = "none";
            loadEvents(filterSelect.value, null, 1);
          } else {
            tableContainer.style.display = "none";
            calendarContainer.style.display = "flex";
            initializeSelects();
            updateCalendarView();
          }
        });

        filterSelect.addEventListener("change", function () {
          loadEvents(this.value, null, 1);
        });

        searchButton.addEventListener("click", function () {
          const searchTerm = searchInput.value;
          const start = startDate.value;
          const end = endDate.value;
          const field = searchField.value;

          loadEvents(filterSelect.value, { searchTerm, start, end, field }, 1);
        });

        resetButton.addEventListener("click", function () {
          searchInput.value = "";
          startDate.value = "";
          endDate.value = "";
          searchField.value = "all";
          loadEvents(filterSelect.value, null, 1);
        });

        prevPageButton.addEventListener("click", function () {
          if (currentPage > 1) {
            currentPage--;
            loadEvents(filterSelect.value, null, currentPage);
          }
        });

        nextPageButton.addEventListener("click", function () {
          const events = JSON.parse(localStorage.getItem("events")) || [];
          const totalPages = Math.ceil(events.length / eventsPerPage);
          if (currentPage < totalPages) {
            currentPage++;
            loadEvents(filterSelect.value, null, currentPage);
          }
        });

        selectAllButton.addEventListener("click", function () {
          const checkboxes = tbody.querySelectorAll('input[type="checkbox"]');
          const allChecked = Array.from(checkboxes).every((cb) => cb.checked);

          checkboxes.forEach((checkbox, index) => {
            const globalIndex = (currentPage - 1) * eventsPerPage + index;
            checkbox.checked = !allChecked;
            const row = checkbox.closest("tr");
            if (!allChecked) {
              selectedEvents.add(globalIndex);
              row.classList.add("selected");
            } else {
              selectedEvents.delete(globalIndex);
              row.classList.remove("selected");
            }
          });

          if (selectedEvents.size > 0) {
            lastSelectedIndex = Math.max(...selectedEvents);
            const lastSelectedRow =
              tbody.rows[lastSelectedIndex % eventsPerPage];
            if (lastSelectedRow) {
              lastSelectedRow.classList.add("last-selected");
            }
            const events = JSON.parse(localStorage.getItem("events")) || [];
            const event = events[lastSelectedIndex];
            if (event) {
              eventNameField.value = event.name;
              eventDateField.value = event.date;
              eventTimeField.value = event.time;
              editIndexField.value = lastSelectedIndex;
            }
          } else {
            lastSelectedIndex = null;
            form.reset();
            editIndexField.value = "";
            const now = new Date();
            eventDateField.value = now.toISOString().split("T")[0];
            eventTimeField.value = now.toTimeString().split(" ")[0].slice(0, 5);
          }
          updateDeleteButtonState();
        });

        selectBetweenButton.addEventListener("click", function () {
          const checkboxes = Array.from(
            tbody.querySelectorAll('input[type="checkbox"]')
          );
          const selectedIndices = checkboxes.reduce((acc, checkbox, index) => {
            if (checkbox.checked)
              acc.push((currentPage - 1) * eventsPerPage + index);
            return acc;
          }, []);

          if (selectedIndices.length !== 2) {
            alert("Please select exactly two events to select between.");
            return;
          }

          const [start, end] = selectedIndices.sort((a, b) => a - b);

          for (let i = start; i <= end; i++) {
            selectedEvents.add(i);
            const rowIndex = i % eventsPerPage;
            if (rowIndex < checkboxes.length) {
              checkboxes[rowIndex].checked = true;
              checkboxes[rowIndex].closest("tr").classList.add("selected");
            }
          }

          lastSelectedIndex = end;
          const lastSelectedRow = tbody.rows[lastSelectedIndex % eventsPerPage];
          if (lastSelectedRow) {
            lastSelectedRow.classList.add("last-selected");
          }

          const events = JSON.parse(localStorage.getItem("events")) || [];
          const event = events[lastSelectedIndex];
          if (event) {
            eventNameField.value = event.name;
            eventDateField.value = event.date;
            eventTimeField.value = event.time;
            editIndexField.value = lastSelectedIndex;
          }
          updateDeleteButtonState();
        });

        document
          .getElementById("deleteSelected")
          .addEventListener("click", function () {
            if (selectedEvents.size > 0) {
              const events = JSON.parse(localStorage.getItem("events")) || [];
              const newEvents = events.filter(
                (_, index) => !selectedEvents.has(index)
              );
              localStorage.setItem("events", JSON.stringify(newEvents));
              loadEvents(filterSelect.value, null, 1);
              updateCalendarView();
              selectedEvents.clear();
              lastSelectedIndex = null;
              form.reset();
              editIndexField.value = "";
              const now = new Date();
              eventDateField.value = now.toISOString().split("T")[0];
              eventTimeField.value = now
                .toTimeString()
                .split(" ")[0]
                .slice(0, 5);
              eventNameField.focus();
              updateDeleteButtonState();
            } else {
              alert("Please select at least one event to delete.");
            }
          });

        toggleFreeDaysButton.addEventListener("click", function () {
          showFreeDays = !showFreeDays;
          loadEvents(filterSelect.value, null, currentPage);
        });

        document
          .getElementById("exportCSV")
          .addEventListener("click", function () {
            const events = JSON.parse(localStorage.getItem("events")) || [];
            let csvContent =
              "data:text/csv;charset=utf-8,Event Name,Date,Time\n";

            events.forEach((event) => {
              const row = `${event.name},${event.date},${event.time}`;
              csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "events.csv");
            document.body.appendChild(link);

            link.click();
            document.body.removeChild(link);
          });

        document
          .getElementById("loadCSV")
          .addEventListener("change", function (event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
              const content = e.target.result;
              const lines = content.split("\n");

              const events = [];

              for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                  const [name, date, time] = line.split(",");
                  events.push({
                    name: name.trim(),
                    date: date.trim(),
                    time: time.trim(),
                  });
                }
              }

              localStorage.setItem("events", JSON.stringify(events));

              loadEvents(filterSelect.value, null, 1);
              updateCalendarView();

              event.target.value = "";
            };

            reader.readAsText(file);
          });

        yearSelect.addEventListener("change", () => {
          currentYear = parseInt(yearSelect.value);
          updateCalendarView();
        });

        monthSelect.addEventListener("change", () => {
          currentMonth = parseInt(monthSelect.value);
          currentWeekStart = new Date(currentYear, currentMonth, 1);
          currentWeekStart.setDate(
            currentWeekStart.getDate() - currentWeekStart.getDay()
          );
          updateCalendarView();
        });

        prevWeekButton.addEventListener("click", () => {
          currentWeekStart.setDate(currentWeekStart.getDate() - 7);
          updateCalendarView();
        });

        nextWeekButton.addEventListener("click", () => {
          currentWeekStart.setDate(currentWeekStart.getDate() + 7);
          updateCalendarView();
        });

        Array.from(table.tHead.rows[0].cells).forEach((th, index) => {
          if (index > 0) {
            th.addEventListener("click", () => {
              const newDirection = th.classList.contains("asc")
                ? "desc"
                : "asc";
              sortTable(index, newDirection);
            });
          }
        });

        // Initialize views
        const now = new Date();
        eventDateField.value = now.toISOString().split("T")[0];
        eventTimeField.value = now.toTimeString().split(" ")[0].slice(0, 5);
        loadEvents();
        initializeSelects();
        updateCalendarView();
        viewSelect.dispatchEvent(new Event("change"));
        document.getElementById("eventName").focus();
      });
    </script>
  </body>
</html>
